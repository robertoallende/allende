# Unit 08_email_004: API Gateway Integration with Amplify

## Objective
Create secure API endpoint using AWS API Gateway and integrate with Amplify deployment to provide HTTP access to the Lambda function for the conversational email flow frontend.

## Problem Analysis

### Current State
- ✅ **SNS notifications**: Working email delivery system (Unit 8.1)
- ✅ **IAM security**: Secure Lambda execution role (Unit 8.2)
- ✅ **Lambda function**: Deployed and processing requests (Unit 8.3)
- ❌ **HTTP endpoint**: No way for frontend to call Lambda function
- ❌ **CORS configuration**: Frontend cannot make cross-origin requests
- ❌ **API integration**: No connection between chat interface and backend

### Desired State
- ✅ **API Gateway endpoint**: HTTPS endpoint for frontend integration
- ✅ **Lambda integration**: API Gateway invokes contact form processor
- ✅ **CORS configuration**: Frontend can make requests from any domain
- ✅ **Amplify integration**: API endpoint available in Amplify environment
- ✅ **Security configuration**: Proper authentication and rate limiting
- ✅ **API documentation**: Clear endpoint specification for frontend

## Technical Specification

### API Gateway Configuration
- **API Type**: REST API (more features than HTTP API)
- **API Name**: `contact-form-api`
- **Stage**: `prod` (production deployment)
- **Endpoint Type**: Regional (better performance and lower cost)
- **Protocol**: HTTPS only (secure communication)

### Resource Structure
```
/contact-form-api/
└── /submit (POST)
    ├── Lambda Integration: contact-form-processor
    ├── CORS: Enabled for all origins
    ├── Request Validation: JSON schema validation
    └── Response Models: Success/Error responses
```

### Lambda Integration
- **Integration Type**: Lambda Proxy Integration
- **Lambda Function**: `contact-form-processor` (from Unit 8.3)
- **Invoke Permission**: API Gateway can invoke Lambda
- **Request Format**: Pass through all request data to Lambda
- **Response Format**: Lambda returns complete HTTP response

### CORS Configuration
```json
{
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token",
  "Access-Control-Allow-Methods": "POST,OPTIONS"
}
```

### Request/Response Specification

#### Request Format
```http
POST /prod/submit
Content-Type: application/json

{
  "name": "John Doe",
  "email": "john@example.com",
  "message": "I love your AWS articles and want to collaborate",
  "verificationPassed": true,
  "timestamp": "2025-08-25T10:12:32.995Z"
}
```

#### Success Response
```http
HTTP/1.1 200 OK
Content-Type: application/json
Access-Control-Allow-Origin: *

{
  "message": "Message sent successfully!",
  "requestId": "abc123-def456"
}
```

#### Error Response
```http
HTTP/1.1 400 Bad Request
Content-Type: application/json
Access-Control-Allow-Origin: *

{
  "error": "Name is required"
}
```

## Implementation Steps

### Step 1: Create API Gateway REST API
- **Create API**: Set up new REST API with regional endpoint
- **Configure settings**: Enable CORS, set up throttling
- **Create resource**: `/submit` resource for contact form submissions
- **Configure method**: POST method with Lambda proxy integration

### Step 2: Configure Lambda Integration
- **Integration setup**: Connect POST method to Lambda function
- **Permissions**: Grant API Gateway permission to invoke Lambda
- **Request mapping**: Pass all request data to Lambda function
- **Response mapping**: Return Lambda response directly to client

### Step 3: Set Up CORS Configuration
- **Enable CORS**: Configure for all origins during development
- **Headers**: Allow Content-Type and other required headers
- **Methods**: Enable POST and OPTIONS methods
- **Preflight**: Handle OPTIONS requests for CORS preflight

### Step 4: Deploy API
- **Create deployment**: Deploy API to production stage
- **Stage configuration**: Set up prod stage with proper settings
- **Custom domain**: Optional custom domain configuration
- **Documentation**: Generate API documentation

### Step 5: Test API Endpoint
- **Direct testing**: Test API endpoint with curl/Postman
- **CORS testing**: Verify cross-origin requests work
- **Error handling**: Test various error scenarios
- **Performance**: Verify response times and reliability

### Step 6: Amplify Integration
- **Environment variables**: Add API endpoint to Amplify environment
- **Build configuration**: Update Amplify build to use API endpoint
- **Deployment**: Deploy updated frontend with API integration
- **Testing**: End-to-end testing of complete flow

## Infrastructure as Code Approach

### Directory Structure
```
api-gateway/
├── README.md              # Complete documentation
├── .gitignore             # Protect sensitive files
├── scripts/
│   ├── setup-api.sh       # Create API Gateway and integration
│   ├── test-api.sh        # Test API endpoint comprehensively
│   ├── status-api.sh      # Monitor API status and metrics
│   ├── update-api.sh      # Update API configuration
│   └── destroy-api.sh     # Cleanup API resources
├── config/
│   └── api-config.json    # Generated configuration (protected)
└── docs/
    └── api-spec.json      # OpenAPI specification
```

### AWS CLI Scripts
- **Automated setup**: Create API, resources, methods, and deployment
- **Configuration management**: Store API endpoint and settings
- **Testing automation**: Comprehensive API testing with various scenarios
- **Monitoring**: Check API status, metrics, and recent requests
- **Cleanup**: Safe removal of API Gateway resources

## Security Configuration

### Authentication Strategy
- **Development**: No authentication (open endpoint for testing)
- **Production**: Consider API key or Cognito integration
- **Rate limiting**: Throttling to prevent abuse
- **Request validation**: JSON schema validation for input

### CORS Security
- **Development**: Allow all origins (`*`) for flexibility
- **Production**: Restrict to specific domain (allende.ai)
- **Headers**: Only allow necessary headers
- **Methods**: Only POST and OPTIONS methods

### Input Validation
- **API Gateway validation**: Basic JSON schema validation
- **Lambda validation**: Comprehensive validation in function
- **Error handling**: Secure error messages without sensitive data

## Integration Points

### Unit 8.3 Dependencies
- **Lambda Function ARN**: From `lambda/config/lambda-config.json`
- **Function permissions**: API Gateway needs invoke permission
- **Response format**: Lambda returns proper HTTP response

### Unit 8.5 Integration
- **API Endpoint URL**: For frontend HTTP requests
- **CORS configuration**: Enables frontend cross-origin requests
- **Request format**: JSON payload specification for frontend

### Amplify Integration
- **Environment variables**: API_ENDPOINT for frontend build
- **Build configuration**: Update frontend to use real API
- **Deployment**: Automatic deployment with API integration

## Testing Strategy

### API Testing Scenarios
1. **Valid submission**: Complete contact form data
2. **Missing fields**: Test validation error handling
3. **Invalid email**: Test email format validation
4. **CORS preflight**: Test OPTIONS request handling
5. **Large payload**: Test request size limits
6. **Rate limiting**: Test throttling behavior

### Integration Testing
- **End-to-end flow**: Frontend → API Gateway → Lambda → SNS → Email
- **Error propagation**: Ensure errors reach frontend properly
- **Performance**: Response time and reliability testing
- **Security**: CORS and input validation testing

### Monitoring and Observability
- **CloudWatch metrics**: Request count, latency, errors
- **API Gateway logs**: Request/response logging for debugging
- **Lambda integration**: Verify Lambda invocations from API
- **Error tracking**: Monitor 4xx and 5xx error rates

## Expected Deliverables

### API Gateway Resources
- **REST API**: `contact-form-api` with regional endpoint
- **Resource**: `/submit` for contact form submissions
- **Method**: POST with Lambda proxy integration
- **Deployment**: Production stage with proper configuration
- **CORS**: Enabled for frontend integration

### Configuration Files
- **API endpoint URL**: For frontend integration
- **API Gateway ID**: For management and updates
- **Stage configuration**: Production deployment settings
- **Integration details**: Lambda function connection

### Documentation
- **API specification**: OpenAPI/Swagger documentation
- **Usage examples**: Request/response examples
- **Error codes**: Complete error handling documentation
- **Integration guide**: Frontend integration instructions

### Testing and Validation
- **API testing**: Comprehensive endpoint testing
- **CORS validation**: Cross-origin request testing
- **Performance metrics**: Response time and reliability
- **Error handling**: Proper error response validation

## Success Criteria

1. ✅ **API Gateway created**: REST API with proper configuration
2. ✅ **Lambda integration**: API successfully invokes Lambda function
3. ✅ **CORS enabled**: Frontend can make cross-origin requests
4. ✅ **Endpoint testing**: API responds correctly to all test scenarios
5. ✅ **Error handling**: Proper error responses for invalid requests
6. ✅ **Performance**: Response times under 2 seconds
7. ✅ **Documentation**: Complete API specification and usage guide
8. ✅ **Amplify ready**: API endpoint available for frontend integration

## Next Steps Integration

### Unit 8.5 Preparation
- **API Endpoint URL**: Available for frontend HTTP requests
- **Request format**: JSON specification for frontend implementation
- **Error handling**: Error response format for frontend processing
- **CORS configuration**: Enables frontend cross-origin requests

### Frontend Integration Points
- **Replace mock calls**: Update email conversation handler to use real API
- **Error handling**: Process API error responses in frontend
- **Loading states**: Handle API request/response timing
- **Success feedback**: Process successful submission responses

## Cost Considerations

### API Gateway Pricing
- **REST API requests**: $3.50 per million requests
- **Data transfer**: $0.09 per GB
- **Free tier**: 1 million requests per month for 12 months

### Estimated Costs (Contact Form Usage)
- **100 submissions/month**: ~$0.0004 (essentially free)
- **1,000 submissions/month**: ~$0.004
- **10,000 submissions/month**: ~$0.04

### Cost Optimization
- **Regional endpoint**: Lower cost than edge-optimized
- **Efficient Lambda**: Fast execution reduces overall costs
- **Proper caching**: Reduce unnecessary API calls

## Risk Mitigation

### Common Issues
- **CORS problems**: Comprehensive CORS configuration and testing
- **Lambda timeout**: Proper timeout configuration and error handling
- **Rate limiting**: Appropriate throttling to prevent abuse
- **Integration errors**: Thorough testing of API-Lambda integration

### Monitoring and Alerting
- **Error rate monitoring**: Alert on high error rates
- **Latency monitoring**: Alert on slow response times
- **Throttling alerts**: Monitor rate limiting events
- **Lambda errors**: Track Lambda function errors from API calls

## Status: Planned

This unit will create the HTTP bridge between the frontend conversational email flow and the backend Lambda function, enabling users to send emails to Roberto through the chat interface with proper API integration, CORS support, and Amplify deployment compatibility.

The API Gateway will provide a secure, scalable, and monitored endpoint that transforms the Lambda function into a web-accessible service ready for frontend integration.
