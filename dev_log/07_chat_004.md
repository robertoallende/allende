# Unit 07_chat_004: Add Name Collection to Email Flow

## Objective
Enhance the conversational email flow to collect the user's name, creating a complete 5-step process that gathers all necessary information for professional email notifications to Roberto.

## Problem Analysis

### Current Email Flow (4 steps)
```
User: "Send an Email to Roberto"
Bot: "I'd be happy to help you send Roberto an email! What would you like to tell him?"

User: "I love your AWS articles and want to collaborate"
Bot: "Great message! What's your email address so Roberto can reply to you?"

User: "john@example.com"
Bot: "Perfect! Just need to verify you're human first. What programming language does Roberto use for AWS Lambda functions?"

User: "Python"
Bot: "You're absolutely right! Your message has been sent to Roberto."
```

### Missing Information
- **No name collection**: Roberto receives emails without knowing the sender's name
- **Impersonal notifications**: Email notifications lack personal touch
- **Professional communication**: Business emails should include sender identification

### Desired Enhanced Flow (5 steps)
```
User: "Send an Email to Roberto"
Bot: "I'd be happy to help you send Roberto an email! What's your name so Roberto knows who's reaching out?"

User: "John Doe"
Bot: "Nice to meet you, John! What's your email address so Roberto can reply to you?"

User: "john@example.com"
Bot: "Perfect! Just need to verify you're human first. What would you like to tell him?"

User: "I love your AWS articles and want to collaborate."
Bot: "Great message! What programming language does Roberto use for AWS Lambda functions?"

User: "Python"
Bot: "You're absolutely right! Your message has been sent to Roberto. He typically responds within 24-48 hours."
```

## Technical Specification

### Updated Email Conversation Steps
1. **Name Collection**: "What's your name so Roberto knows who's reaching out?"
2. **Email Collection**: "What's your email address so Roberto can reply to you?"
3. **Message Collection**: "What would you like to tell him?" ← **MOVED TO STEP 3**
4. **Human Verification**: Random verification question
5. **Success Confirmation**: "Your message has been sent to Roberto"

### Enhanced State Management
```typescript
export type EmailConversationStep = 
  | 'collecting_name'      // ← STEP 1
  | 'collecting_email'     // ← STEP 2
  | 'collecting_message'   // ← STEP 3 (moved from first)
  | 'verifying_human'      // ← STEP 4
  | 'sending' 
  | 'complete' 
  | null;

export interface EmailConversationState {
  step: EmailConversationStep;
  userName?: string;        // ← COLLECTED FIRST
  userEmail?: string;       // ← COLLECTED SECOND
  userMessage?: string;     // ← COLLECTED THIRD
  currentQuestion?: VerificationQuestion;
  usedQuestionIds: string[];
}
```

### Name Validation
```typescript
function isValidName(name: string): boolean {
  const trimmedName = name.trim();
  
  // Basic validation rules
  if (trimmedName.length < 2) return false;
  if (trimmedName.length > 100) return false;
  
  // Allow letters, spaces, hyphens, apostrophes (international names)
  const nameRegex = /^[a-zA-ZÀ-ÿ\u0100-\u017F\u0180-\u024F\u1E00-\u1EFF\s'-]+$/;
  return nameRegex.test(trimmedName);
}
```

## Implementation Plan

### Step 1: Update Email Conversation Handler

#### 1.1 Update Flow Start (Name Collection First)
```typescript
// In email-conversation-handler.ts
export function startEmailConversation(): string {
  emailConversationState = {
    step: 'collecting_name',  // ← START WITH NAME
    usedQuestionIds: []
  };
  
  return "I'd be happy to help you send Roberto an email! What's your name so Roberto knows who's reaching out?";
}
```

#### 1.2 Add Name Collection Step
```typescript
case 'collecting_name':
  const name = message.trim();
  
  if (!isValidName(name)) {
    return {
      response: "Could you please provide your full name? Just your first and last name would be perfect."
    };
  }
  
  // Store name and move to email collection
  emailConversationState = {
    ...state,
    step: 'collecting_email',
    userName: name
  };
  
  return {
    response: `Nice to meet you, ${name}! What's your email address so Roberto can reply to you?`
  };
```

#### 1.3 Update Email Collection Step
```typescript
case 'collecting_email':
  const email = message.trim();
  
  if (!isValidEmail(email)) {
    return {
      response: "That doesn't look like a valid email address. Could you please provide a valid email so Roberto can reply?"
    };
  }
  
  // Store email and move to message collection
  emailConversationState = {
    ...state,
    step: 'collecting_message',
    userEmail: email
  };
  
  return {
    response: "Perfect! Just need to verify you're human first. What would you like to tell him?"
  };
```

#### 1.4 Add Message Collection Step
```typescript
case 'collecting_message':
  // Store message and move to verification
  const question = getRandomQuestion(state.usedQuestionIds);
  emailConversationState = {
    ...state,
    step: 'verifying_human',
    userMessage: message.trim(),
    currentQuestion: question,
    usedQuestionIds: [...state.usedQuestionIds, question.id]
  };
  
  return {
    response: `Great message! ${question.question}`
  };
```

### Step 2: Enhanced Success Message
```typescript
case 'verifying_human':
  // ... existing verification logic ...
  
  if (isCorrect) {
    emailConversationState = {
      ...state,
      step: 'complete'
    };
    
    return {
      response: `You're absolutely right, ${state.userName}! Your message has been sent to Roberto. He typically responds within 24-48 hours.`,
      action: 'SEND_EMAIL'
    };
  }
```

### Step 3: Update Multi-Thread Runtime Logging
```typescript
// In multi-thread-runtime.tsx
if (emailResult.action === 'SEND_EMAIL') {
  const emailState = (await import('@/services/email-conversation-handler')).getEmailConversationState();
  console.log('Email would be sent here:', {
    name: emailState.userName,        // ← NEW
    message: emailState.userMessage,
    replyTo: emailState.userEmail,
    originalTrigger: emailResult.originalMessage
  });
}
```

## User Experience Enhancement

### Personalized Interactions
- **Greeting by name**: "Nice to meet you, John!"
- **Personal success message**: "You're absolutely right, John!"
- **Professional communication**: Roberto knows who contacted him

### Natural Conversation Flow
```
User: "Send an Email to Roberto"
Bot: "I'd be happy to help you send Roberto an email! What's your name so Roberto knows who's reaching out?"

User: "Sarah Johnson"
Bot: "Nice to meet you, Sarah! What's your email address so Roberto can reply to you?"

User: "sarah.johnson@company.com"
Bot: "Perfect! Just need to verify you're human first. What would you like to tell him?"

User: "I'm interested in collaborating on AWS projects"
Bot: "Great message! Which football team does Roberto support?"

User: "Real Madrid"
Bot: "You're absolutely right, Sarah! Your message has been sent to Roberto. He typically responds within 24-48 hours."
```

### Error Handling for Names
```typescript
// Invalid name examples and responses
"A" → "Could you please provide your full name? Just your first and last name would be perfect."
"" → "Could you please provide your full name? Just your first and last name would be perfect."
"John123" → "Could you please provide your full name? Just your first and last name would be perfect."
```

## Integration with Backend (Unit 8.1+)

### Enhanced Email Notification Format
```
Subject: Contact Form: Sarah Johnson

Contact Form Submission

Name: Sarah Johnson
Email: sarah.johnson@company.com

Message:
I'm interested in collaborating on AWS projects and would love to discuss potential opportunities.

Submitted: 2025-08-25T06:57:36.160Z
Verification: Passed
```

### Complete Data Collection
```json
{
  "userName": "Sarah Johnson",
  "userEmail": "sarah.johnson@company.com", 
  "userMessage": "I'm interested in collaborating on AWS projects...",
  "verificationPassed": true,
  "timestamp": "2025-08-25T06:57:36.160Z"
}
```

## Files to Modify

### Updated Files
- `src/services/email-conversation-handler.ts` - Add name collection step and validation
- `components/chat/multi-thread-runtime.tsx` - Update logging to include name
- `src/data/verification-questions.ts` - No changes needed

### New Validation Function
```typescript
// Add to email-conversation-handler.ts
function isValidName(name: string): boolean {
  const trimmedName = name.trim();
  
  if (trimmedName.length < 2 || trimmedName.length > 100) {
    return false;
  }
  
  // Allow international names with letters, spaces, hyphens, apostrophes
  const nameRegex = /^[a-zA-ZÀ-ÿ\u0100-\u017F\u0180-\u024F\u1E00-\u1EFF\s'-]+$/;
  return nameRegex.test(trimmedName);
}
```

## Testing Scenarios

### Valid Names
- "John Doe" ✅
- "María García" ✅
- "Jean-Pierre Dubois" ✅
- "O'Connor" ✅
- "李小明" ✅

### Invalid Names
- "A" ❌ (too short)
- "John123" ❌ (contains numbers)
- "" ❌ (empty)
- "John@Doe" ❌ (contains symbols)

## Success Criteria

1. ✅ **Name Collection Step Added**: New step between message and email collection
2. ✅ **Name Validation Working**: Proper validation with user-friendly error messages
3. ✅ **Personalized Responses**: Bot uses user's name in subsequent messages
4. ✅ **Complete Data Collection**: Name, email, and message all captured
5. ✅ **Enhanced Notifications**: Email notifications include sender's name
6. ✅ **Natural Flow**: Conversation feels smooth and professional
7. ✅ **Error Handling**: Graceful handling of invalid names with retry

## Impact on Backend Units

### Unit 8.1 (SNS Setup)
- **Enhanced notification format** with sender name in subject and body
- **More professional emails** to Roberto with complete sender information

### Unit 8.3 (Lambda Function)
- **Additional field processing** for userName in request body
- **Enhanced email formatting** with name in subject line and message body

### Unit 8.5 (Frontend Integration)
- **Complete data payload** with all three fields (name, email, message)
- **Professional user experience** with personalized interactions

## Status: Planned

This unit completes the conversational email flow by adding the missing name collection step, creating a professional, complete contact system that gathers all necessary information for meaningful communication between users and Roberto.

The enhanced flow maintains the natural conversational style while ensuring Roberto receives properly formatted, professional email notifications with complete sender information.
