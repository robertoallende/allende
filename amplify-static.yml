version: 1
applications:
  - appRoot: s3/frontend
    frontend:
      phases:
        preBuild:
          commands:
            # Use Node 20 for Next.js 15 compatibility
            - nvm use 20 || nvm install 20
            # Enable Corepack and activate pnpm
            - corepack enable
            - corepack prepare pnpm@9.12.0 --activate
            # Install dependencies with frozen lockfile for reproducible builds
            - pnpm install --frozen-lockfile
        build:
          commands:
            # Build Next.js application with content generation and static export
            - pnpm run build
            # Move static files to build directory (generic static site structure)
            - mkdir -p build
            - cp -r out/* build/
            - echo "Static site build completed"
      artifacts:
        # Use generic build directory instead of Next.js-specific out
        baseDirectory: build
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - ~/.pnpm-store/**/*
          - .next/cache/**/*
      # Environment variables for production
      env:
        variables:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
