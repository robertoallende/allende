version: 1
applications:
  - appRoot: s3/frontend
    frontend:
      phases:
        preBuild:
          commands:
            # Copy package.json to root to help Amplify detect Next.js version
            - cp package.json ../../package.json
            - echo "Copied package.json to root for Amplify detection"
            # Use Node 20 for Next.js 15 compatibility
            - nvm use 20 || nvm install 20
            # Enable Corepack and activate pnpm
            - corepack enable
            - corepack prepare pnpm@9.12.0 --activate
            # Install dependencies with frozen lockfile for reproducible builds
            - pnpm install --frozen-lockfile
        build:
          commands:
            # Run the actual build (content generation + Next.js build)
            - pnpm run actualBuild
            # The "build" script with "next export" tricks Amplify into SSG mode
            - echo "Build completed - package.json copied to root, SSG mode should be detected"
      artifacts:
        # Next.js static export outputs to 'out' directory
        baseDirectory: out
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - ~/.pnpm-store/**/*
          - .next/cache/**/*
      # Environment variables for production
      env:
        variables:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
