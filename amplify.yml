version: 1
applications:
  - appRoot: s3/frontend
    frontend:
      phases:
        preBuild:
          commands:
            # Use Node 20 for Next.js 15 compatibility
            - nvm use 20 || nvm install 20
            # Enable Corepack and activate pnpm
            - corepack enable
            - corepack prepare pnpm@9.12.0 --activate
            # Install dependencies with frozen lockfile for reproducible builds
            - pnpm install --frozen-lockfile
        build:
          commands:
            # Build Next.js application with content generation and static export
            - pnpm run build
            # Move static files outside Next.js context to avoid SSR detection
            - cd ../..
            - mkdir -p build
            - cp -r s3/frontend/out/* build/
            - ls -la build/
            - echo "Static files moved outside Next.js context - deployment ready"
      artifacts:
        # Deploy from root build directory (outside Next.js context)
        baseDirectory: ../../build
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - ~/.pnpm-store/**/*
          - .next/cache/**/*
      # Environment variables for production
      env:
        variables:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
