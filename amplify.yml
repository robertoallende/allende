version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            # Use Node 20 for Next.js 15 compatibility
            - nvm use 20 || nvm install 20
            # Enable Corepack and activate pnpm
            - corepack enable
            - corepack prepare pnpm@9.12.0 --activate
            # Navigate to frontend directory and install dependencies
            - cd s3/frontend
            - pnpm install --frozen-lockfile
        build:
          commands:
            # Build Next.js application from frontend directory
            - cd s3/frontend
            - pnpm run build
            # Move static files to root build directory (outside Next.js context)
            - cd ../..
            - mkdir -p build
            - cp -r s3/frontend/out/* build/
            - ls -la build/
            - echo "Static files moved outside Next.js context - deployment ready"
      artifacts:
        # Deploy from root build directory (no Next.js detection)
        baseDirectory: build
        files:
          - '**/*'
      cache:
        paths:
          - s3/frontend/node_modules/**/*
          - s3/frontend/.next/cache/**/*
      # Environment variables for production
      env:
        variables:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
